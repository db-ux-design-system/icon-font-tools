---
name: Publish

on:
  workflow_call:

jobs:
  validate:
    name: Publish
    runs-on: ubuntu-24.04 # Use Ubuntu 24.04 explicitly
    permissions:
      id-token: write  # Required for OIDC
    steps:
      - name: â¬ Checkout repo
        uses: actions/checkout@v6

      - name: ðŸ”„ Init PNPM
        uses: ./.github/actions/pnpm-init

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
            node-version-file: ".nvmrc"

      - name: â¬ Download dist
        uses: actions/download-artifact@v6
        with:
          name: build
          path: dist

      - name: ðŸ”€ Extract tag
        shell: bash
        run: echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        id: extractTag

      - name: ðŸ”œ Publish to npm
        env:
          TAG: ${{ steps.extractTag.outputs.tag }}
          NPM_TAG: ${{ github.event.release.prerelease && 'next' || 'latest' }}
        run: |
          echo "node, npm and release version:"
          node -v
          npm -v
          SEMVER_VERSION=$(npx find-versions-cli "$TAG")
          npm version --no-git-tag-version "$SEMVER_VERSION"
          npm config set registry https://registry.npmjs.org/
          npm publish --tag $NPM_TAG
